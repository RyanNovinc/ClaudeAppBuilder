<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Success Stories - AppFoundry</title>
  
  <!-- Add your existing CSS -->
  <link rel="stylesheet" href="styles.css">
  
  <!-- Add Supabase Client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <style>
    /* Success Stories specific styles */
    .stories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 30px;
      margin-top: 40px;
    }
    
    .story-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.3s ease;
      padding: 20px;
    }
    
    .story-card:hover {
      transform: translateY(-5px);
    }
    
    .story-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .story-header h3 {
      margin: 0;
      color: #333;
      font-size: 1.4rem;
    }
    
    .app-type {
      background: #e9f5ff;
      color: #0078ff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
    }
    
    .story-author {
      color: #666;
      margin-bottom: 15px;
      font-style: italic;
    }
    
    .story-testimonial {
      margin-bottom: 20px;
      line-height: 1.6;
      color: #444;
      font-style: italic;
    }
    
    .story-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .story-images img {
      width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .read-more {
      display: inline-block;
      color: #0078ff;
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
    }
    
    .read-more:hover {
      text-decoration: underline;
    }
    
    /* Modal Styles */
    .story-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 30px;
      border-radius: 12px;
      width: 80%;
      max-width: 800px;
      position: relative;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .close {
      color: #aaa;
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }
    
    .story-full {
      line-height: 1.8;
      margin: 20px 0;
      white-space: pre-line;
    }
    
    .story-images-full {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 30px;
    }
    
    .story-images-full img {
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
    }
    
    .loading-spinner {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: #f9f9f9;
      border-radius: 8px;
      color: #666;
    }
    
    .error {
      text-align: center;
      padding: 20px;
      background: #fff0f0;
      color: #cc0000;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <!-- Header Section -->
  <header>
    <div class="container">
      <div class="logo">
        <a href="index.html">AppFoundry</a>
      </div>
      <nav>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="success-stories.html" class="active">Success Stories</a></li>
          <li><a href="submit-success-story.html">Submit Your Story</a></li>
          <li><a href="#" class="cta-button">Join Course</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="hero success-stories-hero">
    <div class="container">
      <h1>Success Stories</h1>
      <p>See how others have succeeded with AppFoundry's methods</p>
    </div>
  </section>

  <!-- Stories Section -->
  <section class="container">
    <div id="stories-container" class="stories-grid">
      <!-- Stories will be loaded here -->
      <div class="loading-spinner">Loading stories...</div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-logo">
          <h3>AppFoundry</h3>
          <p>Building apps without coding</p>
        </div>
        <div class="footer-links">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="success-stories.html">Success Stories</a></li>
            <li><a href="#">About Us</a></li>
            <li><a href="#">Contact</a></li>
          </ul>
        </div>
        <div class="footer-links">
          <h4>Resources</h4>
          <ul>
            <li><a href="#">Blog</a></li>
            <li><a href="#">Getting Started</a></li>
            <li><a href="#">FAQ</a></li>
            <li><a href="#">Terms of Service</a></li>
          </ul>
        </div>
        <div class="footer-newsletter">
          <h4>Stay Updated</h4>
          <p>Subscribe to our newsletter</p>
          <form>
            <input type="email" placeholder="Your email">
            <button type="submit">Subscribe</button>
          </form>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 AppFoundry. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    // Initialize Supabase client
    const supabaseUrl = 'https://vyzsauyekanaxevgxkyh.supabase.co';
    const supabaseAnonKey = 'your-anon-key'; // Replace with your actual anon key
    
    // Function to load approved stories
    async function loadApprovedStories() {
      try {
        // Show loading state
        const storiesContainer = document.getElementById('stories-container');
        if (storiesContainer) {
          storiesContainer.innerHTML = '<div class="loading-spinner">Loading stories...</div>';
        }
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        // Fetch only approved stories from Supabase
        const { data: stories, error } = await supabase
          .from('submissions')
          .select('*')
          .eq('status', 'approved')
          .order('created_at', { ascending: false });
          
        if (error) throw error;
        
        console.log(`Loaded ${stories.length} approved stories from Supabase`);
        
        // Display the stories
        displayStories(stories);
      } catch (error) {
        console.error('Error loading stories:', error);
        
        // Try fetching from API as fallback
        try {
          const response = await fetch('/.netlify/functions/get-approved-stories');
          if (!response.ok) throw new Error('API response was not ok');
          
          const stories = await response.json();
          displayStories(stories);
        } catch (apiError) {
          console.error('API fallback failed:', apiError);
          const storiesContainer = document.getElementById('stories-container');
          if (storiesContainer) {
            storiesContainer.innerHTML = '<div class="error">Failed to load success stories. Please try again later.</div>';
          }
        }
      }
    }
    
    // Function to display stories
    function displayStories(stories) {
      const storiesContainer = document.getElementById('stories-container');
      if (!storiesContainer) return;
      
      if (!stories || stories.length === 0) {
        storiesContainer.innerHTML = '<div class="empty-state">No success stories yet. Be the first to share your experience!</div>';
        return;
      }
      
      // Clear container
      storiesContainer.innerHTML = '';
      
      // Create story cards
      stories.forEach(story => {
        // Parse cloudinary_images if needed
        let images = [];
        try {
          if (story.cloudinary_images) {
            if (typeof story.cloudinary_images === 'string') {
              images = JSON.parse(story.cloudinary_images);
            } else {
              images = story.cloudinary_images;
            }
          }
        } catch (e) {
          console.error('Error parsing images:', e);
        }
        
        // Create card element
        const card = document.createElement('div');
        card.className = 'story-card';
        
        // Create card content
        card.innerHTML = `
          <div class="story-header">
            <h3>${story.app_name}</h3>
            <span class="app-type">${story.app_type || ''}</span>
          </div>
          <div class="story-author">By ${story.name}</div>
          <div class="story-testimonial">${story.testimonial}</div>
          ${images.length > 0 ? `
            <div class="story-images">
              ${images.map(img => `<img src="${img}" alt="${story.app_name} screenshot" />`).join('')}
            </div>
          ` : ''}
          <a href="javascript:void(0)" class="read-more" data-id="${story.id}">Read the full story</a>
        `;
        
        // Add event listener for "Read the full story" button
        const readMoreButton = card.querySelector('.read-more');
        if (readMoreButton) {
          readMoreButton.addEventListener('click', function() {
            showFullStory(story);
          });
        }
        
        storiesContainer.appendChild(card);
      });
    }
    
    // Function to show full story in a modal
    function showFullStory(story) {
      // Create modal element if it doesn't exist
      let modal = document.getElementById('story-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'story-modal';
        modal.className = 'story-modal';
        document.body.appendChild(modal);
      }
      
      // Parse cloudinary_images if needed
      let images = [];
      try {
        if (story.cloudinary_images) {
          if (typeof story.cloudinary_images === 'string') {
            images = JSON.parse(story.cloudinary_images);
          } else {
            images = story.cloudinary_images;
          }
        }
      } catch (e) {
        console.error('Error parsing images:', e);
      }
      
      // Create modal content
      modal.innerHTML = `
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2>${story.app_name}</h2>
          <p class="story-author">By ${story.name}</p>
          <p class="story-type">${story.app_type || ''}</p>
          <div class="story-testimonial">${story.testimonial}</div>
          <div class="story-full">${story.story.replace(/\n/g, '<br>')}</div>
          ${images.length > 0 ? `
            <div class="story-images-full">
              ${images.map(img => `<img src="${img}" alt="${story.app_name} screenshot" />`).join('')}
            </div>
          ` : ''}
        </div>
      `;
      
      // Add event listener to close button
      const closeButton = modal.querySelector('.close');
      if (closeButton) {
        closeButton.addEventListener('click', function() {
          modal.style.display = 'none';
        });
      }
      
      // Show modal
      modal.style.display = 'block';
    }
    
    // Load stories when page loads
    document.addEventListener('DOMContentLoaded', loadApprovedStories);
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('story-modal');
      if (modal && event.target === modal) {
        modal.style.display = 'none';
      }
    });
  </script>
</body>
</html>
