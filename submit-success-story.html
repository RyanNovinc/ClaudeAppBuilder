<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Your Success Story - AppFoundry</title>
    
    <!-- Storage Management Script -->
    <script>
    // Storage management helper functions
    const StorageManager = {
        // Get size of localStorage in bytes
        getLocalStorageSize: function() {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += (localStorage[key].length + key.length) * 2; // Approximate UTF-16 size
                }
            }
            return total;
        },
        
        // Get human-readable size
        formatSize: function(bytes) {
            if (bytes < 1024) return bytes + " bytes";
            else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + " KB";
            else return (bytes / 1048576).toFixed(2) + " MB";
        },
        
        // Check if localStorage is near full (80% of quota)
        isNearFull: function() {
            // Typical quota is 5MB, but can vary
            const estimatedQuota = 5 * 1024 * 1024;
            const size = this.getLocalStorageSize();
            return size > (estimatedQuota * 0.8);
        },
        
        // Clean up space by removing old submissions
        cleanupStorage: function() {
            try {
                // Get current submissions
                const submissionsKey = 'appfoundry_submissions';
                const submissions = JSON.parse(localStorage.getItem(submissionsKey) || '[]');
                
                if (submissions.length > 10) {
                    // Keep only the 10 most recent submissions
                    const recent = submissions.slice(0, 10);
                    localStorage.setItem(submissionsKey, JSON.stringify(recent));
                    
                    // Also update seed
                    localStorage.setItem('appfoundry_approved_seed', JSON.stringify(recent));
                    
                    console.log("Storage cleaned up. Kept 10 most recent submissions.");
                    return true;
                }
                
                return false;
            } catch (e) {
                console.error("Error cleaning storage:", e);
                return false;
            }
        },
        
        // Try to save with cleanup if needed
        safeSave: function(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                // If quota exceeded, try cleanup
                if (e.name === 'QuotaExceededError' || 
                    e.code === 22 || // Chrome
                    e.code === 1014 || // Firefox
                    e.message.includes('quota')) {
                    
                    console.log("Storage quota exceeded. Attempting cleanup...");
                    
                    // Try to clean up space
                    this.cleanupStorage();
                    
                    // Try again
                    try {
                        localStorage.setItem(key, value);
                        return true;
                    } catch (e2) {
                        // If still failing, try more aggressive cleanup
                        this.emergencyCleanup();
                        
                        try {
                            localStorage.setItem(key, value);
                            return true;
                        } catch (e3) {
                            console.error("Storage save failed even after cleanup:", e3);
                            return false;
                        }
                    }
                } else {
                    console.error("Error saving to localStorage:", e);
                    return false;
                }
            }
        },
        
        // Emergency cleanup - more aggressive space saving
        emergencyCleanup: function() {
            try {
                // Clear non-critical items
                localStorage.removeItem('appfoundry_visited_submission');
                localStorage.removeItem('appfoundry_navigation');
                
                // Keep only 5 most recent submissions as last resort
                const submissionsKey = 'appfoundry_submissions';
                const submissions = JSON.parse(localStorage.getItem(submissionsKey) || '[]');
                
                if (submissions.length > 5) {
                    const recent = submissions.slice(0, 5);
                    localStorage.setItem(submissionsKey, JSON.stringify(recent));
                    localStorage.setItem('appfoundry_approved_seed', JSON.stringify(recent));
                }
                
                console.log("Emergency cleanup performed");
            } catch (e) {
                console.error("Emergency cleanup failed:", e);
            }
        }
    };
    </script>
    
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Include your existing styles here */
        
        /* Add styles for storage warning */
        .storage-warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo"><a href="index.html">AppFoundry</a></div>
            <nav>
                <ul>
                    <li><a href="index.html#overview">Overview</a></li>
                    <li><a href="index.html#curriculum">Curriculum</a></li>
                    <li><a href="index.html#pricing">Pricing</a></li>
                    <li><a href="success-stories.html">Success Stories</a></li>
                    <li><a href="about-creator.html">About</a></li>
                </ul>
            </nav>
            <button class="cta-button small" id="loginButton">Log in</button>
        </div>
    </header>

    <div class="form-container">
        <div class="form-header">
            <h1>Share Your Success Story</h1>
            <p>Tell us about the app you built with AppFoundry and inspire others to bring their ideas to life!</p>
        </div>
        
        <div class="form-content">
            <!-- Success view that appears after form submission -->
            <div id="success-view" class="success-view" style="display: none;">
                <div class="success-icon">✓</div>
                <h2 class="success-title">Your Story Has Been Submitted!</h2>
                <p class="success-message">Thank you for sharing your success story with us! After review, it will be featured on our success stories page to inspire others.</p>
                <a href="success-stories.html" class="cta-button">View Success Stories</a>
            </div>
            
            <div id="storage-warning" class="storage-warning">
                Note: Your browser storage is nearly full. Consider clearing your browser data if you experience issues.
            </div>
            
            <div id="status-message" class="status-message"></div>
            
            <!-- Form will be hidden after successful submission -->
            <div id="form-section">
                <form id="success-story-form" name="success-story" method="POST">
                    <!-- Hidden field for Netlify form handling -->
                    <input type="hidden" name="form-name" value="success-story" />
                    
                    <div class="form-group">
                        <label for="name">Your Name</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" name="email" required>
                            <div class="form-tip">Your email won't be displayed publicly.</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="app-type">Type of App</label>
                            <select id="app-type" name="app-type" required>
                                <option value="" disabled selected>Select app category</option>
                                <option value="Health & Fitness">Health & Fitness</option>
                                <option value="Productivity">Productivity</option>
                                <option value="Lifestyle">Lifestyle</option>
                                <option value="Business">Business</option>
                                <option value="Education">Education</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Social">Social</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="experience-level">Your Experience Level</label>
                        <select id="experience-level" name="experience-level" required>
                            <option value="" disabled selected>Select your coding experience</option>
                            <option value="No experience">No coding experience</option>
                            <option value="Beginner">Beginner (less than 1 year)</option>
                            <option value="Intermediate">Intermediate (1-3 years)</option>
                            <option value="Advanced">Advanced (3+ years)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="app-name">Your App Name</label>
                        <input type="text" id="app-name" name="app-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="story">Your Success Story</label>
                        <textarea id="story" name="story" required placeholder="Tell us about your experience building your app with AppFoundry. What challenges did you overcome? How has it impacted you or your business?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="testimonial">Short Testimonial (for display)</label>
                        <textarea id="testimonial" name="testimonial" required placeholder="Write a brief testimonial (1-2 sentences) that we can feature on our success stories page."></textarea>
                    </div>
                    
                    <!-- NOTE: Image upload removed to save localStorage space -->
                    
                    <button type="submit" class="submit-button">Submit Your Story</button>
                    
                    <div class="form-note">
                        <p>By submitting this form, you agree to let us feature your story on our website.</p>
                    </div>
                </form>
            </div>
            
            <div class="return-link">
                <a href="success-stories.html" class="link-button">Back to Success Stories</a>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="logo">AppFoundry</div>
            <div class="footer-links">
                <div class="link-group">
                    <h4>Course</h4>
                    <ul>
                        <li><a href="index.html#overview">Overview</a></li>
                        <li><a href="index.html#curriculum">Curriculum</a></li>
                        <li><a href="index.html#pricing">Pricing</a></li>
                        <li><a href="success-stories.html">Success Stories</a></li>
                        <li><a href="about-creator.html">About Creator</a></li>
                    </ul>
                </div>
                <div class="link-group">
                    <h4>Legal</h4>
                    <ul>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="refund-policy.html">Our Guarantee</a></li>
                    </ul>
                </div>
                <div class="link-group">
                    <h4>Contact</h4>
                    <ul>
                        <li><a href="mailto:hello@risegg.net">Email Support</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                © 2025 AppFoundry. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check storage status on page load
            if (StorageManager.isNearFull()) {
                document.getElementById('storage-warning').style.display = 'block';
            }
            
            // Handle form submission
            const form = document.getElementById('success-story-form');
            const statusMessage = document.getElementById('status-message');
            const formSection = document.getElementById('form-section');
            const successView = document.getElementById('success-view');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Show loading state
                const submitButton = document.querySelector('.submit-button');
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';
                
                try {
                    // Get form data
                    const name = document.getElementById('name').value;
                    const email = document.getElementById('email').value;
                    const appType = document.getElementById('app-type').value;
                    const appName = document.getElementById('app-name').value;
                    const story = document.getElementById('story').value;
                    const testimonial = document.getElementById('testimonial').value;
                    const experienceLevel = document.getElementById('experience-level').value;
                    
                    // Create submission object - NO IMAGES to save space
                    const newSubmission = {
                        id: 'story_' + Date.now(),
                        name,
                        email,
                        appName,
                        appType,
                        experienceLevel,
                        testimonial,
                        story,
                        date: new Date().toISOString(),
                        status: 'pending'
                    };
                    
                    // Get existing submissions
                    let existingSubmissions = [];
                    try {
                        const storedSubmissions = localStorage.getItem('appfoundry_submissions');
                        if (storedSubmissions) {
                            existingSubmissions = JSON.parse(storedSubmissions);
                        }
                    } catch (parseError) {
                        console.error('Error parsing existing submissions:', parseError);
                    }
                    
                    // Add new submission to beginning of array
                    existingSubmissions.unshift(newSubmission);
                    
                    // If storage is near full, clean up first
                    if (StorageManager.isNearFull()) {
                        console.log("Storage is near full, cleaning up before saving");
                        StorageManager.cleanupStorage();
                    }
                    
                    // Save back to localStorage with error handling
                    const jsonData = JSON.stringify(existingSubmissions);
                    const saveSuccess = StorageManager.safeSave('appfoundry_submissions', jsonData);
                    
                    // Also update seed only if main save succeeded
                    if (saveSuccess) {
                        StorageManager.safeSave('appfoundry_approved_seed', jsonData);
                    }
                    
                    if (saveSuccess) {
                        // Success! Hide form and show success view
                        formSection.style.display = 'none';
                        successView.style.display = 'block';
                    } else {
                        throw new Error("Unable to save submission due to storage limitations. Try clearing browser data.");
                    }
                    
                } catch (error) {
                    console.error('Error submitting form:', error);
                    
                    // Show error message
                    statusMessage.textContent = error.message || 'An error occurred while submitting your story. Please try again.';
                    statusMessage.className = 'status-message error';
                    statusMessage.style.display = 'block';
                    
                    // Scroll to top to show error message
                    window.scrollTo({
                        top: statusMessage.offsetTop - 100,
                        behavior: 'smooth'
                    });
                } finally {
                    // Reset button regardless of outcome
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit Your Story';
                }
            });
        });
    </script>
</body>
</html>
