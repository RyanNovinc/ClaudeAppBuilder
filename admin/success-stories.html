<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin: Success Stories - AppFoundry</title>

    <!-- Add Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <!-- Supabase JS Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Admin Auth Helper Script with Supabase Integration -->
    <script>
    /**
     * Admin Authentication Helper with Supabase Integration
     * This file provides a consistent interface for authenticating with the Netlify Functions API
     * and includes Supabase integration for direct database operations
     */

    const AdminAuth = {
      // The token from your admin page - replace this with your actual token
      token: "xP8q#Rb7!DtEv3mK9$Lz",
      
      // Supabase configuration - using correct values
      supabaseUrl: 'https://vyzsauyekanaxevgxkyh.supabase.co',
      supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5enNhdXlla2FuYXhldmd4a3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzMjgzOTIsImV4cCI6MjA2MTkwNDM5Mn0.VPs_JhAkoCUediOP4_0flNF9AURcQDH-Hfj8T0vi5_c',
      supabaseClient: null,
      
      // Initialize Supabase client
      initSupabase() {
        if (!this.supabaseClient && typeof supabase !== 'undefined') {
          try {
            this.supabaseClient = supabase.createClient(this.supabaseUrl, this.supabaseAnonKey);
            console.log("🔄 Supabase client initialized");
            return this.supabaseClient;
          } catch (e) {
            console.error("❌ Error initializing Supabase client:", e);
            return null;
          }
        }
        return this.supabaseClient;
      },
      
      // Call any API endpoint with proper authentication
      async callApi(endpoint, method = 'GET', body = null) {
        try {
          const options = {
            method: method,
            headers: {
              'Authorization': `Bearer ${this.token}`,
              'Content-Type': 'application/json'
            }
          };
          
          if (body) {
            options.body = JSON.stringify(body);
          }
          
          console.log(`📡 Calling API: ${endpoint} (${method})`);
          const response = await fetch(`/.netlify/functions/${endpoint}`, options);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error(`❌ API error (${response.status}):`, errorText);
            throw new Error(`API error (${response.status}): ${errorText}`);
          }
          
          console.log(`✅ API call successful: ${endpoint}`);
          return await response.json();
        } catch (error) {
          console.error(`❌ API call to ${endpoint} failed:`, error);
          
          // Track failed API calls for monitoring
          this.recordApiFailure(endpoint, method, error);
          
          throw error;
        }
      },
      
      // Get submissions with status filter
      async getSubmissions(status = 'all') {
        try {
          // Try to use API first
          return await this.callApi(`get-submissions?status=${status}`);
        } catch (error) {
          logActivity('warning', `API call to get submissions failed: ${error.message}. Trying direct Supabase connection.`);
          
          // Fallback to direct Supabase connection if API fails
          return this.getSubmissionsFromSupabase(status);
        }
      },
      
      // Get submissions directly from Supabase
      async getSubmissionsFromSupabase(status = 'all') {
        try {
          // Initialize Supabase client if needed
          const client = this.initSupabase();
          if (!client) {
            throw new Error("Supabase client not available");
          }
          
          // Build query
          let query = client.from('submissions').select('*');
          
          if (status !== 'all') {
            query = query.eq('status', status);
          }
          
          // Execute query
          const { data, error } = await query.order('created_at', { ascending: false });
          
          if (error) throw error;
          
          // Format submissions to match expected structure
          return data.map(submission => {
            // Parse cloudinary_images
            let images = [];
            try {
              if (submission.cloudinary_images) {
                if (typeof submission.cloudinary_images === 'string') {
                  images = JSON.parse(submission.cloudinary_images);
                } else if (Array.isArray(submission.cloudinary_images)) {
                  images = submission.cloudinary_images;
                }
              }
            } catch (e) {
              console.error(`Error parsing cloudinary_images for submission ${submission.id}:`, e);
            }
            
            return {
              id: submission.id,
              name: submission.name,
              email: submission.email,
              appName: submission.app_name,
              appType: submission.app_type,
              experienceLevel: submission.experience_level,
              testimonial: submission.testimonial,
              story: submission.story,
              status: submission.status,
              date: submission.created_at,
              images: images
            };
          });
        } catch (error) {
          logActivity('error', `Error getting submissions from Supabase: ${error.message}`);
          
          // Fall back to localStorage as a last resort
          return this.getSubmissionsFromLocalStorage(status);
        }
      },
      
      // Get submissions from localStorage as last fallback
      getSubmissionsFromLocalStorage(status = 'all') {
        try {
          logActivity('warning', "Falling back to localStorage for submissions");
          
          const storedSubmissions = localStorage.getItem('appfoundry_submissions');
          
          if (!storedSubmissions) {
            return [];
          }
          
          let submissions = JSON.parse(storedSubmissions);
          
          if (status !== 'all') {
            submissions = submissions.filter(sub => sub.status === status);
          }
          
          return submissions;
        } catch (error) {
          logActivity('error', `Error getting submissions from localStorage: ${error.message}`);
          return [];
        }
      },
      
      // Approve a submission
      async approveSubmission(id) {
        try {
          logActivity('info', `Approving submission ${id}`);
          
          // Try API first
          try {
            const result = await this.callApi('approve-submission', 'POST', { id });
            
            // Update localStorage as fallback
            this.updateLocalStorage(id, 'approved');
            
            return result;
          } catch (apiError) {
            logActivity('warning', `API call to approve submission failed: ${apiError.message}. Trying direct Supabase connection.`);
            
            // Fallback to direct Supabase connection
            return this.approveSubmissionInSupabase(id);
          }
        } catch (error) {
          logActivity('error', `Error approving submission: ${error.message}`);
          throw error;
        }
      },
      
      // Approve submission directly in Supabase
      async approveSubmissionInSupabase(id) {
        try {
          // Initialize Supabase client if needed
          const client = this.initSupabase();
          if (!client) {
            throw new Error("Supabase client not available");
          }
          
          // Update the submission
          const { data, error } = await client
            .from('submissions')
            .update({ status: 'approved' })
            .eq('id', id)
            .select()
            .single();
            
          if (error) throw error;
          
          // Update localStorage
          this.updateLocalStorage(id, 'approved');
          
          // Format the result to match the API response
          const formattedSubmission = {
            id: data.id,
            name: data.name,
            email: data.email,
            appName: data.app_name,
            appType: data.app_type,
            experienceLevel: data.experience_level,
            testimonial: data.testimonial,
            story: data.story,
            status: data.status,
            date: data.created_at,
            images: this.parseCloudinaryImages(data.cloudinary_images)
          };
          
          logActivity('success', `Successfully approved submission ${id} in Supabase`);
          
          return {
            success: true,
            message: "Submission approved successfully",
            submission: formattedSubmission
          };
        } catch (error) {
          logActivity('error', `Error approving submission in Supabase: ${error.message}`);
          
          // Fall back to localStorage as a last resort
          const success = this.updateLocalStorage(id, 'approved');
          
          if (success) {
            logActivity('info', `Approved submission ${id} in localStorage only`);
            
            return {
              success: true,
              message: "Submission approved in localStorage only",
              offline: true
            };
          }
          
          throw error;
        }
      },
      
      // Reject a submission
      async rejectSubmission(id) {
        try {
          logActivity('info', `Rejecting submission ${id}`);
          
          // Try API first
          try {
            const result = await this.callApi('reject-submission', 'POST', { id });
            
            // Update localStorage as fallback
            this.updateLocalStorage(id, 'rejected');
            
            return result;
          } catch (apiError) {
            logActivity('warning', `API call to reject submission failed: ${apiError.message}. Trying direct Supabase connection.`);
            
            // Fallback to direct Supabase connection
            return this.rejectSubmissionInSupabase(id);
          }
        } catch (error) {
          logActivity('error', `Error rejecting submission: ${error.message}`);
          throw error;
        }
      },
      
      // Reject submission directly in Supabase
      async rejectSubmissionInSupabase(id) {
        try {
          // Initialize Supabase client if needed
          const client = this.initSupabase();
          if (!client) {
            throw new Error("Supabase client not available");
          }
          
          // Update the submission
          const { data, error } = await client
            .from('submissions')
            .update({ status: 'rejected' })
            .eq('id', id)
            .select()
            .single();
            
          if (error) throw error;
          
          // Update localStorage
          this.updateLocalStorage(id, 'rejected');
          
          // Format the result to match the API response
          const formattedSubmission = {
            id: data.id,
            name: data.name,
            email: data.email,
            appName: data.app_name,
            appType: data.app_type,
            experienceLevel: data.experience_level,
            testimonial: data.testimonial,
            story: data.story,
            status: data.status,
            date: data.created_at,
            images: this.parseCloudinaryImages(data.cloudinary_images)
          };
          
          logActivity('success', `Successfully rejected submission ${id} in Supabase`);
          
          return {
            success: true,
            message: "Submission rejected successfully",
            submission: formattedSubmission
          };
        } catch (error) {
          logActivity('error', `Error rejecting submission in Supabase: ${error.message}`);
          
          // Fall back to localStorage as a last resort
          const success = this.updateLocalStorage(id, 'rejected');
          
          if (success) {
            logActivity('info', `Rejected submission ${id} in localStorage only`);
            
            return {
              success: true,
              message: "Submission rejected in localStorage only",
              offline: true
            };
          }
          
          throw error;
        }
      },
      
      // Parse Cloudinary images
      parseCloudinaryImages(cloudinaryImages) {
        if (!cloudinaryImages) return [];
        
        try {
          if (typeof cloudinaryImages === 'string') {
            return JSON.parse(cloudinaryImages);
          }
          
          if (Array.isArray(cloudinaryImages)) {
            return cloudinaryImages;
          }
        } catch (error) {
          console.error('Error parsing Cloudinary images:', error);
        }
        
        return [];
      },
      
      // Clear all rejected submissions
      async clearRejectedSubmissions() {
        try {
          logActivity('info', `Clearing all rejected submissions`);
          
          // Try Supabase directly
          const supabase = this.initSupabase();
          if (!supabase) {
            throw new Error("Supabase client not available");
          }
          
          // Count how many rejected submissions there are
          const { count, error: countError } = await supabase
            .from('submissions')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'rejected');
            
          if (countError) throw countError;
          
          if (count === 0) {
            return {
              success: true,
              message: "No rejected submissions to clear"
            };
          }
          
          // Delete rejected submissions
          const { error: deleteError } = await supabase
            .from('submissions')
            .delete()
            .eq('status', 'rejected');
            
          if (deleteError) throw deleteError;
          
          // Update localStorage
          this.clearRejectedSubmissionsInLocalStorage();
          
          logActivity('success', `Successfully cleared ${count} rejected submissions from Supabase`);
          
          return {
            success: true,
            message: `Successfully cleared ${count} rejected submissions`
          };
        } catch (error) {
          logActivity('error', `Error clearing rejected submissions in Supabase: ${error.message}`);
          
          // Fall back to localStorage as a last resort
          this.clearRejectedSubmissionsInLocalStorage();
          
          logActivity('info', `Cleared rejected submissions in localStorage only`);
          
          return {
            success: true,
            message: "Rejected submissions cleared in localStorage only",
            offline: true
          };
        }
      },
      
      // Clear rejected submissions in localStorage
      clearRejectedSubmissionsInLocalStorage() {
        try {
          const submissions = JSON.parse(localStorage.getItem('appfoundry_submissions') || '[]');
          const updatedSubmissions = submissions.filter(sub => sub.status !== 'rejected');
          
          localStorage.setItem('appfoundry_submissions', JSON.stringify(updatedSubmissions));
          
          // Update seed immediately too
          localStorage.setItem('appfoundry_approved_seed', JSON.stringify(
            updatedSubmissions.filter(s => s.status === 'approved')
          ));
          
          logActivity('info', `Cleared rejected submissions in localStorage`);
          return true;
        } catch (error) {
          logActivity('error', `Error clearing rejected submissions in localStorage: ${error.message}`);
          return false;
        }
      },
      
      // Update submission (for editing)
      async updateSubmission(submission) {
        try {
          logActivity('info', `Updating submission ${submission.id}`);
          
          // Try direct Supabase update
          const supabase = this.initSupabase();
          if (!supabase) {
            throw new Error("Supabase client not available");
          }
          
          // Format the submission for Supabase
          const supabaseSubmission = {
            name: submission.name,
            email: submission.email,
            app_name: submission.appName,
            app_type: submission.appType,
            experience_level: submission.experienceLevel,
            testimonial: submission.testimonial,
            story: submission.story,
            updated_at: new Date().toISOString()
          };
          
          // Add images if provided
          if (submission.images) {
            supabaseSubmission.cloudinary_images = JSON.stringify(submission.images);
          }
          
          // Update in Supabase
          const { data, error } = await supabase
            .from('submissions')
            .update(supabaseSubmission)
            .eq('id', submission.id)
            .select()
            .single();
            
          if (error) throw error;
          
          // Update in localStorage
          this.updateSubmissionInLocalStorage(submission);
          
          // Format the result
          const formattedSubmission = {
            id: data.id,
            name: data.name,
            email: data.email,
            appName: data.app_name,
            appType: data.app_type,
            experienceLevel: data.experience_level,
            testimonial: data.testimonial,
            story: data.story,
            status: data.status,
            date: data.created_at,
            images: this.parseCloudinaryImages(data.cloudinary_images)
          };
          
          logActivity('success', `Successfully updated submission ${submission.id} in Supabase`);
          
          return {
            success: true,
            message: "Submission updated successfully",
            submission: formattedSubmission
          };
        } catch (error) {
          logActivity('error', `Error updating submission in Supabase: ${error.message}`);
          
          // Fall back to localStorage as a last resort
          const success = this.updateSubmissionInLocalStorage(submission);
          
          if (success) {
            logActivity('info', `Updated submission ${submission.id} in localStorage only`);
            
            return {
              success: true,
              message: "Submission updated in localStorage only",
              offline: true
            };
          }
          
          throw error;
        }
      },
      
      // Update submission in localStorage
      updateSubmissionInLocalStorage(updatedSubmission) {
        try {
          // Find the submission
          const submissions = JSON.parse(localStorage.getItem('appfoundry_submissions') || '[]');
          const submissionIndex = submissions.findIndex(s => s.id === updatedSubmission.id);
          
          if (submissionIndex !== -1) {
            // Update the submission with new data
            submissions[submissionIndex] = {
              ...submissions[submissionIndex],
              ...updatedSubmission
            };
            
            // Save to localStorage
            localStorage.setItem('appfoundry_submissions', JSON.stringify(submissions));
            
            // Update seed immediately too
            localStorage.setItem('appfoundry_approved_seed', JSON.stringify(
              submissions.filter(s => s.status === 'approved')
            ));
            
            logActivity('info', `LocalStorage updated for submission ${updatedSubmission.id}`);
            return true;
          }
          
          logActivity('warning', `Could not find submission ${updatedSubmission.id} in localStorage for update`);
          return false;
        } catch (error) {
          logActivity('error', `Error updating submission in localStorage: ${error.message}`);
          return false;
        }
      },
      
      // Delete a submission
      async deleteSubmission(id) {
        try {
          logActivity('info', `Deleting submission ${id}`);
          
          // Try direct Supabase deletion
          const supabase = this.initSupabase();
          if (!supabase) {
            throw new Error("Supabase client not available");
          }
          
          // Delete from Supabase
          const { error } = await supabase
            .from('submissions')
            .delete()
            .eq('id', id);
            
          if (error) throw error;
          
          // Delete from localStorage
          this.deleteSubmissionFromLocalStorage(id);
          
          logActivity('success', `Successfully deleted submission ${id} from Supabase`);
          
          return {
            success: true,
            message: "Submission deleted successfully"
          };
        } catch (error) {
          logActivity('error', `Error deleting submission from Supabase: ${error.message}`);
          
          // Fall back to localStorage as a last resort
          const success = this.deleteSubmissionFromLocalStorage(id);
          
          if (success) {
            logActivity('info', `Deleted submission ${id} from localStorage only`);
            
            return {
              success: true,
              message: "Submission deleted from localStorage only",
              offline: true
            };
          }
          
          throw error;
        }
      },
      
      // Delete submission from localStorage
      deleteSubmissionFromLocalStorage(id) {
        try {
          const submissions = JSON.parse(localStorage.getItem('appfoundry_submissions') || '[]');
          const updatedSubmissions = submissions.filter(sub => sub.id !== id);
          
          if (submissions.length === updatedSubmissions.length) {
            logActivity('warning', `Submission ${id} not found in localStorage`);
            return false;
          }
          
          localStorage.setItem('appfoundry_submissions', JSON.stringify(updatedSubmissions));
          
          // Update seed immediately too
          localStorage.setItem('appfoundry_approved_seed', JSON.stringify(
            updatedSubmissions.filter(s => s.status === 'approved')
          ));
          
          logActivity('info', `Deleted submission ${id} from localStorage`);
          return true;
        } catch (error) {
          logActivity('error', `Error deleting submission from localStorage: ${error.message}`);
          return false;
        }
      },
      
      // Helper function to update localStorage as a fallback
      updateLocalStorage(id, status) {
        try {
          // Find the submission
          const submissions = JSON.parse(localStorage.getItem('appfoundry_submissions') || '[]');
          const submissionIndex = submissions.findIndex(s => s.id === id);
          
          if (submissionIndex !== -1) {
            // Update status
            submissions[submissionIndex].status = status;
            
            // Save to localStorage
            localStorage.setItem('appfoundry_submissions', JSON.stringify(submissions));
            
            // Update seed immediately too
            localStorage.setItem('appfoundry_approved_seed', JSON.stringify(
              submissions.filter(s => s.status === 'approved')
            ));
            console.log(`💾 LocalStorage updated: status of ${id} changed to ${status}`);
            logActivity('info', `LocalStorage updated: status of ${id} changed to ${status}`);
            return true;
          }
          
          logActivity('warning', `Could not find submission ${id} in localStorage`);
          return false;
        } catch (error) {
          console.error('❌ Error updating localStorage:', error);
          logActivity('error', `Error updating localStorage: ${error.message}`);
          return false;
        }
      },
      
      // Force sync submissions from Supabase to localStorage
      async forceSync() {
        try {
          logActivity('info', 'Force syncing submissions from Supabase');
          
          // Initialize Supabase client if needed
          const supabase = this.initSupabase();
          if (!supabase) {
            throw new Error("Supabase client not available");
          }
          
          // Get all submissions from Supabase
          const { data, error } = await supabase
            .from('submissions')
            .select('*')
            .order('created_at', { ascending: false });
            
          if (error) throw error;
          
          if (!Array.isArray(data) || data.length === 0) {
            logActivity('warning', 'No submissions found in Supabase');
            return { success: false, message: 'No submissions found in Supabase' };
          }
          
          // Format submissions
          const formattedSubmissions = data.map(submission => ({
            id: submission.id,
            name: submission.name,
            email: submission.email,
            appName: submission.app_name,
            appType: submission.app_type,
            experienceLevel: submission.experience_level,
            testimonial: submission.testimonial,
            story: submission.story,
            status: submission.status,
            date: submission.created_at,
            images: this.parseCloudinaryImages(submission.cloudinary_images)
          }));
          
          // Update localStorage
          localStorage.setItem('appfoundry_submissions', JSON.stringify(formattedSubmissions));
          
          // Update approved seed
          localStorage.setItem('appfoundry_approved_seed', JSON.stringify(
            formattedSubmissions.filter(s => s.status === 'approved')
          ));
          
          // Update last sync timestamp
          localStorage.setItem('appfoundry_last_sync', new Date().toISOString());
          
          logActivity('success', `Successfully synced ${formattedSubmissions.length} submissions from Supabase`);
          
          return {
            success: true,
            message: `Successfully synced ${formattedSubmissions.length} submissions from Supabase`,
            submissions: formattedSubmissions
          };
        } catch (error) {
          logActivity('error', `Force sync failed: ${error.message}`);
          throw error;
        }
      },
      
      // Track API failures for monitoring
      recordApiFailure(endpoint, method, error) {
        try {
          const failures = JSON.parse(localStorage.getItem('appfoundry_api_failures') || '[]');
          failures.push({
            endpoint,
            method,
            error: error.message,
            timestamp: new Date().toISOString()
          });
          
          // Keep only the last 50 failures
          if (failures.length > 50) {
            failures.shift();
          }
          
          localStorage.setItem('appfoundry_api_failures', JSON.stringify(failures));
        } catch (e) {
          console.error('Failed to record API failure:', e);
        }
      },
      
      // Get API failures history
      getApiFailures() {
        try {
          return JSON.parse(localStorage.getItem('appfoundry_api_failures') || '[]');
        } catch (e) {
          console.error('Failed to get API failures:', e);
          return [];
        }
      },
      
      // Run a health check for the system
      async checkSystemHealth() {
        try {
          logActivity('info', 'Running system health check');
          
          const results = {
            success: false,
            supabase: false,
            netlifyFunctions: false,
            details: []
          };
          
          // Check Supabase connection
          try {
            const supabase = this.initSupabase();
            if (!supabase) {
              throw new Error("Supabase client not available");
            }
            
            // Test a simple query
            const { data, error } = await supabase
              .from('submissions')
              .select('id')
              .limit(1);
              
            if (error) throw error;
            
            results.supabase = true;
            results.details.push({ component: 'Supabase', status: 'Connected' });
          } catch (supabaseError) {
            results.details.push({ component: 'Supabase', status: 'Error', message: supabaseError.message });
          }
          
          // Check Netlify Functions (optional)
          try {
            // Simple health check endpoint - you may need to implement this
            await fetch('/.netlify/functions/health-check');
            
            results.netlifyFunctions = true;
            results.details.push({ component: 'Netlify Functions', status: 'Connected' });
          } catch (netlifyError) {
            results.details.push({ component: 'Netlify Functions', status: 'Error', message: netlifyError.message });
          }
          
          // Overall status
          results.success = results.supabase || results.netlifyFunctions;
          
          return results;
        } catch (error) {
          logActivity('error', `System health check failed: ${error.message}`);
          
          return {
            success: false,
            message: error.message,
            details: [{ component: 'System', status: 'Error', message: error.message }]
          };
        }
      }
    };
