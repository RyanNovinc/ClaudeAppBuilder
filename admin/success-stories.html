<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin: Success Stories - AppFoundry (Fixed)</title>
    
    <!-- Story Manager Script - IMPORTANT: This must be the first script loaded in the head -->
    <script>
    // Universal Story Manager - ensures stories are consistently available
    (function() {
      // Run on all pages to ensure localStorage data consistency
      console.log("üìä Story Manager initializing on admin page");
      
      // Check if we need to seed the localStorage from our backup
      function seedStoriesIfNeeded() {
        // Only run if appfoundry_submissions doesn't exist or is empty
        if (!localStorage.getItem('appfoundry_submissions')) {
          console.log("üå± No stories found in localStorage, checking for seed data");
          
          // Check if we have any stories in our seed
          if (localStorage.getItem('appfoundry_approved_seed')) {
            console.log("üîÑ Restoring stories from seed");
            try {
              const seed = JSON.parse(localStorage.getItem('appfoundry_approved_seed'));
              localStorage.setItem('appfoundry_submissions', JSON.stringify(seed));
              console.log("‚úÖ Successfully restored", seed.length, "stories from seed");
            } catch (e) {
              console.error("‚ùå Error restoring from seed:", e);
            }
          }
        } else {
          // If we have submissions, make sure we have an up-to-date seed
          try {
            const submissions = JSON.parse(localStorage.getItem('appfoundry_submissions'));
            localStorage.setItem('appfoundry_approved_seed', JSON.stringify(submissions));
            console.log("üíæ Seed updated with", submissions.length, "stories");
          } catch (e) {
            console.error("‚ùå Error updating seed:", e);
          }
        }
      }
      
      // Run the seed check immediately
      seedStoriesIfNeeded();
      
      // Hook the approval buttons on the admin page
      hookApprovalButtons();
    })();
    </script>
    
    <style>
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 0;
            background-color: #f9fafb;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 15px 0;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #0070f3;
        }
        .admin-badge {
            background-color: #0070f3;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .header-actions a {
            color: #0070f3;
            text-decoration: none;
            margin-left: 20px;
            font-weight: 500;
        }
        h1 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #111827;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 20px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            color: #0070f3;
            border-bottom-color: #0070f3;
        }
        .tab:hover {
            color: #0070f3;
        }
        .submissions-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .submission-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .submission-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            transition: box-shadow 0.3s;
        }
        .submission-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #f3f4f6;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title {
            font-weight: 600;
            font-size: 16px;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-approved {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-rejected {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .card-body {
            padding: 15px;
        }
        .card-field {
            margin-bottom: 12px;
        }
        .card-field:last-child {
            margin-bottom: 0;
        }
        .field-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 3px;
        }
        .field-value {
            font-size: 14px;
            color: #111827;
        }
        .testimonial {
            font-style: italic;
            background-color: #f9fafb;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .card-images {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .card-image {
            width: 80px;
            height: 80px;
            border-radius: 4px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .card-image:hover {
            transform: scale(1.05);
        }
        .card-actions {
            padding: 12px 15px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid #e5e7eb;
        }
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-approve {
            background-color: #10b981;
            color: white;
        }
        .btn-approve:hover {
            background-color: #059669;
        }
        .btn-reject {
            background-color: #ef4444;
            color: white;
        }
        .btn-reject:hover {
            background-color: #dc2626;
        }
        .btn-view {
            background-color: #f3f4f6;
            color: #374151;
        }
        .btn-view:hover {
            background-color: #e5e7eb;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }
        .empty-icon {
            font-size: 32px;
            margin-bottom: 15px;
            color: #9ca3af;
        }
        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #111827;
        }
        .empty-description {
            color: #6b7280;
            max-width: 400px;
            margin: 0 auto;
        }
        
        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        .modal {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6b7280;
        }
        .modal-body {
            padding: 20px;
        }
        .story-content {
            white-space: pre-line;
            margin-bottom: 20px;
            line-height: 1.7;
        }
        .modal-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .modal-image {
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .modal-image:hover {
            transform: scale(1.02);
        }
        
        /* Image Viewer */
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            display: none;
        }
        .viewer-content {
            position: relative;
            max-width: 90%;
            max-height: 90vh;
        }
        .viewer-image {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        .viewer-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            padding: 20px;
            gap: 10px;
        }
        .page-button {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background-color: white;
            color: #374151;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .page-button:hover {
            border-color: #0070f3;
            color: #0070f3;
        }
        .page-button.active {
            background-color: #0070f3;
            border-color: #0070f3;
            color: white;
        }
        .page-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .switch-container {
            display: flex;
            align-items: center;
            margin-left: auto;
            margin-right: 20px;
        }
        .switch-container label {
            margin-right: 10px;
            font-size: 14px;
            color: #6b7280;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #0070f3;
        }
        input:checked + .slider:before {
            transform: translateX(16px);
        }
        
        /* Export Button Styles */
        .admin-actions {
            margin: 20px 0;
            display: flex;
            align-items: center;
        }
        
        .export-button {
            background-color: #0070f3;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .export-button:hover {
            background-color: #0055b3;
        }
        
        #export-result {
            margin-left: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        
        .export-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .export-error {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #ef4444;
        }

        /* Loading indicator */
        #loading-indicator {
            text-align: center;
            padding: 30px;
            font-size: 16px;
            color: #6b7280;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 112, 243, 0.3);
            border-radius: 50%;
            border-top-color: #0070f3;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Admin panel controls - NEW! */
        .admin-panel {
            background-color: #f0f4ff;
            border: 1px solid #c7d2fe;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .admin-panel h3 {
            margin-top: 0;
            color: #4338ca;
        }
        
        .admin-token-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .admin-token-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .small-button {
            background-color: #6366f1;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .small-button:hover {
            background-color: #4f46e5;
        }
        
        .token-status {
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .token-status.error {
            color: #dc2626;
        }
        
        .token-status.success {
            color: #16a34a;
        }

        .direct-operation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .direct-operation-buttons button {
            padding: 8px 12px;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .direct-operation-buttons .danger {
            background-color: #fee2e2;
            border-color: #fecaca;
            color: #b91c1c;
        }
        
        .update-status {
            font-size: 14px;
            margin-top: 10px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-container">
            <div>
                <span class="logo">AppFoundry</span>
                <span class="admin-badge">Admin</span>
            </div>
            <div class="header-actions">
                <a href="../index.html">View Site</a>
                <a href="../success-stories.html">Public Success Stories</a>
            </div>
        </div>
    </header>
    
    <div class="container">
        <h1>Success Story Submissions - Fixed Version</h1>
        
        <!-- NEW ADMIN PANEL -->
        <div class="admin-panel">
            <h3>Admin Settings</h3>
            <div class="admin-token-input">
                <input type="password" id="admin-token" placeholder="Enter admin token" value="xP8q#Rb7!DtEv3mK9$Lz">
                <button class="small-button" onclick="validateToken()">Validate Token</button>
            </div>
            <div id="token-status" class="token-status"></div>
            
            <div class="direct-operation-buttons">
                <button onclick="openDirectUpdate()">Direct Update Options</button>
                <button class="danger" onclick="clearLocalStorage()">Clear Local Storage</button>
            </div>
            <div id="update-status" class="update-status"></div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-status="all" onclick="changeTab('all')">All Submissions</div>
            <div class="tab" data-status="pending" onclick="changeTab('pending')">Pending</div>
            <div class="tab" data-status="approved" onclick="changeTab('approved')">Approved</div>
            <div class="tab" data-status="rejected" onclick="changeTab('rejected')">Rejected</div>
            
            <div class="switch-container">
                <label for="sort-switch">Newest First</label>
                <label class="switch">
                    <input type="checkbox" id="sort-switch" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        
        <!-- Export Button -->
        <div class="admin-actions">
            <button class="export-button" onclick="exportApprovedStories()">
                Export Approved Stories JSON
            </button>
            <span id="export-result"></span>
        </div>
        
        <div class="submissions-container">
            <div id="loading-indicator">
                <div class="loading-spinner"></div>
                Loading submissions...
            </div>
            
            <div id="submissions" class="submission-cards" style="display: none;">
                <!-- Submissions will be displayed here -->
            </div>
            
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-icon">üì™</div>
                <div class="empty-state-title">No submissions found</div>
                <div class="empty-state-description">There are no success story submissions in this category yet.</div>
            </div>
            
            <div class="pagination" id="pagination">
                <!-- Pagination will be added here -->
            </div>
        </div>
    </div>
    
    <!-- Full Story Modal -->
    <div class="modal-backdrop" id="story-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">App Name</div>
                <button class="modal-close" onclick="closeModal('story-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modal-content">
                    <!-- Story content will be loaded here -->
                </div>
                <div class="modal-images" id="modal-images">
                    <!-- Images will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Direct Update Modal -->
    <div class="modal-backdrop" id="direct-update-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title">Direct Story Update</div>
                <button class="modal-close" onclick="closeModal('direct-update-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Use these options to handle submissions when the normal approval flow fails.</p>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Story ID:</label>
                    <input type="text" id="direct-story-id" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Status:</label>
                    <select id="direct-status" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-approve" style="flex: 1;" onclick="updateLocalStorage()">Update in Local Storage</button>
                    <button class="btn btn-view" style="flex: 1;" onclick="attemptDirectApiUpdate()">Attempt API Update</button>
                </div>
                
                <div id="direct-update-status" style="margin-top: 15px; font-size: 14px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Image Viewer -->
    <div class="image-viewer" id="image-viewer">
        <div class="viewer-content">
            <button class="viewer-close" onclick="closeImageViewer()">&times;</button>
            <img src="" id="full-image" class="viewer-image">
        </div>
    </div>
    
    <script>
        // Constants - getting token from input now
        let ADMIN_TOKEN = "xP8q#Rb7!DtEv3mK9$Lz";
        
        // Global variables
        let allSubmissions = [];
        let currentTab = 'all';
        let currentPage = 1;
        let itemsPerPage = 6;
        let sortNewestFirst = true;
        let currentStoryId = null;
        let tokenValidated = false;
        let approvalAttempts = {};
        
        // Load submissions when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Admin page loaded, loading submissions");
            
            // Get token from local storage if available
            const savedToken = localStorage.getItem('appfoundry_admin_token');
            if (savedToken) {
                document.getElementById('admin-token').value = savedToken;
                ADMIN_TOKEN = savedToken;
            }
            
            loadSubmissions();
            
            // Set up sort switch
            document.getElementById('sort-switch').addEventListener('change', function() {
                sortNewestFirst = this.checked;
                displaySubmissions();
            });
        });

        // Validate admin token
        function validateToken() {
            const tokenInput = document.getElementById('admin-token');
            const tokenStatus = document.getElementById('token-status');
            
            ADMIN_TOKEN = tokenInput.value.trim();
            
            if (!ADMIN_TOKEN) {
                tokenStatus.textContent = "Please enter a token";
                tokenStatus.className = "token-status error";
                tokenStatus.style.display = "block";
                return;
            }
            
            // Save token to localStorage
            localStorage.setItem('appfoundry_admin_token', ADMIN_TOKEN);
            
            // Test token with a simple API call
            fetch('/.netlify/functions/get-submissions?status=all', {
                headers: {
                    "Authorization": "Bearer " + ADMIN_TOKEN
                }
            })
            .then(response => {
                if (response.ok) {
                    tokenStatus.textContent = "Token validated successfully!";
                    tokenStatus.className = "token-status success";
                    tokenValidated = true;
                } else {
                    tokenStatus.textContent = "Invalid token or API error";
                    tokenStatus.className = "token-status error";
                }
                tokenStatus.style.display = "block";
            })
            .catch(error => {
                tokenStatus.textContent = "Error testing token: " + error.message;
                tokenStatus.className = "token-status error";
                tokenStatus.style.display = "block";
            });
        }
        
        // Open direct update modal
        function openDirectUpdate() {
            document.getElementById('direct-update-status').textContent = '';
            document.getElementById('direct-update-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        // Update story status in localStorage only
        function updateLocalStorage() {
            const storyId = document.getElementById('direct-story-id').value.trim();
            const status = document.getElementById('direct-status').value;
            const statusDiv = document.getElementById('direct-update-status');
            
            if (!storyId) {
                statusDiv.textContent = "Please enter a Story ID";
                statusDiv.style.color = "#dc2626";
                return;
            }
            
            try {
                // Get submissions from localStorage
                const storedSubmissions = localStorage.getItem('appfoundry_submissions');
                if (!storedSubmissions) {
                    statusDiv.textContent = "No submissions found in localStorage";
                    statusDiv.style.color = "#dc2626";
                    return;
                }
                
                const submissions = JSON.parse(storedSubmissions);
                const submissionIndex = submissions.findIndex(s => s.id === storyId);
                
                if (submissionIndex === -1) {
                    statusDiv.textContent = `Story with ID ${storyId} not found`;
                    statusDiv.style.color = "#dc2626";
                    return;
                }
                
                // Update status
                submissions[submissionIndex].status = status;
                
                // Save back to localStorage
                localStorage.setItem('appfoundry_submissions', JSON.stringify(submissions));
                localStorage.setItem('appfoundry_approved_seed', JSON.stringify(submissions));
                
                statusDiv.textContent = `Story status updated to ${status} in localStorage. Refresh to see changes.`;
                statusDiv.style.color = "#16a34a";
                
                // Update global variable if loaded
                if (allSubmissions.length > 0) {
                    const globalIndex = allSubmissions.findIndex(s => s.id === storyId);
                    if (globalIndex !== -1) {
                        allSubmissions[globalIndex].status = status;
                    }
                }
                
                // Refresh display after short delay
                setTimeout(() => {
                    displaySubmissions();
                }, 1000);
                
            } catch (error) {
                statusDiv.textContent = "Error updating localStorage: " + error.message;
                statusDiv.style.color = "#dc2626";
            }
        }
        
        // Attempt direct API update with retry logic
        function attemptDirectApiUpdate() {
            const storyId = document.getElementById('direct-story-id').value.trim();
            const status = document.getElementById('direct-status').value;
            const statusDiv = document.getElementById('direct-update-status');
            
            if (!storyId) {
                statusDiv.textContent = "Please enter a Story ID";
                statusDiv.style.color = "#dc2626";
                return;
            }
            
            statusDiv.textContent = "Attempting API update...";
            statusDiv.style.color = "#6b7280";
            
            // Use appropriate endpoint based on status
            let endpoint = '/.netlify/functions/approve-submission';
            if (status === 'rejected') {
                endpoint = '/.netlify/functions/reject-submission';
            } else if (status === 'pending') {
                statusDiv.textContent = "Cannot set to pending via API directly";
                statusDiv.style.color = "#dc2626";
                return;
            }
            
            // Make API call with token
            fetch(endpoint, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + ADMIN_TOKEN
                },
                body: JSON.stringify({ id: storyId })
            })
            .then(response => {
                if (response.ok) {
                    return response.json().then(data => {
                        statusDiv.textContent = `API update successful! Story now ${status}.`;
                        statusDiv.style.color = "#16a34a";
                        
                        // Also update localStorage for consistency
                        updateLocalStorage();
                        
                        return true;
                    });
                } else {
                    return response.text().then(text => {
                        throw new Error(`API responded with error: ${text}`);
                    });
                }
            })
            .catch(error => {
                statusDiv.textContent = `API update failed: ${error.message}. Using localStorage as fallback.`;
                statusDiv.style.color = "#dc2626";
                
                // Update localStorage as fallback
                updateLocalStorage();
            });
        }
        
        // Clear localStorage
        function clearLocalStorage() {
            if (confirm("Are you sure you want to clear all localStorage data? This will remove all locally stored submissions.")) {
                localStorage.removeItem('appfoundry_submissions');
                localStorage.removeItem('appfoundry_approved_seed');
                
                const updateStatus = document.getElementById('update-status');
                updateStatus.textContent = "localStorage cleared. Refresh the page to load from API.";
                updateStatus.style.color = "#dc2626";
            }
        }
        
        // Load submissions with improved error handling
        async function loadSubmissions() {
            try {
                // Show loading indicator
                document.getElementById('loading-indicator').style.display = 'block';
                document.getElementById('submissions').style.display = 'none';
                document.getElementById('empty-state').style.display = 'none';
                
                // Get token from input
                ADMIN_TOKEN = document.getElementById('admin-token').value.trim();
                
                // Fetch submissions from API - try all three auth methods
                console.log("Fetching submissions with auth token...");
                
                // First try with the token in Authorization header with Bearer prefix
                let response = await fetch(`/.netlify/functions/get-submissions?status=${currentTab}`, {
                    headers: {
                        "Authorization": "Bearer " + ADMIN_TOKEN
                    }
                });
                
                // If that fails, try with just the token
                if (!response.ok) {
                    console.log("First auth attempt failed, trying with plain token...");
                    response = await fetch(`/.netlify/functions/get-submissions?status=${currentTab}`, {
                        headers: {
                            "Authorization": ADMIN_TOKEN
                        }
                    });
                }
                
                // If that still fails, try with token as query parameter
                if (!response.ok) {
                    console.log("Second auth attempt failed, trying with token as query parameter...");
                    response = await fetch(`/.netlify/functions/get-submissions?status=${currentTab}&token=${encodeURIComponent(ADMIN_TOKEN)}`);
                }
                
                // Log response status for debugging
                console.log("API Response status:", response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("API error response:", errorText);
                    throw new Error("Failed to fetch submissions: " + errorText);
                }
                
                const data = await response.json();
                allSubmissions = data;
                
                console.log("Loaded", allSubmissions.length, "submissions");
                
                // Fall back to localStorage if no submissions from API
                if (allSubmissions.length === 0) {
                    console.log("No submissions from API, checking localStorage...");
                    try {
                        const storedSubmissions = localStorage.getItem('appfoundry_submissions');
                        
                        if (storedSubmissions) {
                            const localSubmissions = JSON.parse(storedSubmissions);
                            
                            // Filter by status if needed
                            if (currentTab !== 'all') {
                                allSubmissions = localSubmissions.filter(sub => sub.status === currentTab);
                            } else {
                                allSubmissions = localSubmissions;
                            }
                            
                            console.log("Loaded", allSubmissions.length, "submissions from localStorage (fallback)");
                        }
                    } catch (localStorageError) {
                        console.error("Error loading from localStorage:", localStorageError);
                    }
                }
                
                // Display submissions
                displaySubmissions();
            } catch (error) {
                console.error("Error loading submissions:", error);
                
                // Fall back to localStorage
                try {
                    const storedSubmissions = localStorage.getItem('appfoundry_submissions');
                    
                    if (storedSubmissions) {
                        allSubmissions = JSON.parse(storedSubmissions);
                        
                        // Filter by status if needed
                        if (currentTab !== 'all') {
                            allSubmissions = allSubmissions.filter(sub => sub.status === currentTab);
                        }
                        
                        console.log("Loaded", allSubmissions.length, "submissions from localStorage (fallback)");
                        displaySubmissions();
                    } else {
                        showEmptyState();
                    }
                } catch (localStorageError) {
                    console.error("Error loading from localStorage:", localStorageError);
                    showEmptyState();
                }
            } finally {
                document.getElementById('loading-indicator').style.display = 'none';
            }
        }
        
        // Display submissions based on current filter
        function displaySubmissions() {
            // Filter submissions based on current tab
            let filteredSubmissions = allSubmissions;
            
            if (currentTab !== 'all' && filteredSubmissions.some(sub => sub.status)) {
                filteredSubmissions = allSubmissions.filter(submission => submission.status === currentTab);
            }
            
            // Sort submissions
            filteredSubmissions.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return sortNewestFirst ? dateB - dateA : dateA - dateB;
            });
            
            // Show empty state if no submissions
            if (filteredSubmissions.length === 0) {
                showEmptyState();
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredSubmissions.length / itemsPerPage);
            if (currentPage > totalPages) {
                currentPage = 1;
            }
            
            // Get current page items
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredSubmissions.length);
            const currentItems = filteredSubmissions.slice(startIndex, endIndex);
            
            // Display current items
            const submissionsContainer = document.getElementById('submissions');
            submissionsContainer.innerHTML = '';
            
            currentItems.forEach(submission => {
                const submissionCard = createSubmissionCard(submission);
                submissionsContainer.appendChild(submissionCard);
            });
            
            // Update pagination
            updatePagination(totalPages);
            
            // Hide empty state and show submissions
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('submissions').style.display = 'grid';
        }
        
        // Create a submission card
        function createSubmissionCard(submission) {
            const card = document.createElement('div');
            card.className = 'submission-card';
            
            // Get status label and class
            let statusLabel = 'Pending';
            let statusClass = 'status-pending';
            
            if (submission.status === 'approved') {
                statusLabel = 'Approved';
                statusClass = 'status-approved';
            } else if (submission.status === 'rejected') {
                statusLabel = 'Rejected';
                statusClass = 'status-rejected';
            }
            
            // Format date
            const date = new Date(submission.date);
            const formattedDate = date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title">${submission.appName}</div>
                    <div class="status-badge ${statusClass}">${statusLabel}</div>
                </div>
                <div class="card-body">
                    <div class="card-field">
                        <div class="field-label">Story ID</div>
                        <div class="field-value">${submission.id}</div>
                    </div>
                    <div class="card-field">
                        <div class="field-label">Submitted By</div>
                        <div class="field-value">${submission.name}</div>
                    </div>
                    <div class="card-field">
                        <div class="field-label">Email</div>
                        <div class="field-value">${submission.email}</div>
                    </div>
                    <div class="card-field">
                        <div class="field-label">App Type</div>
                        <div class="field-value">${submission.appType || submission.app_type || 'Not specified'}</div>
                    </div>
                    <div class="card-field">
                        <div class="field-label">Experience Level</div>
                        <div class="field-value">${submission.experienceLevel || 'Not specified'}</div>
                    </div>
                    <div class="card-field">
                        <div class="field-label">Testimonial</div>
                        <div class="testimonial">${submission.testimonial}</div>
                    </div>
                    <div class="card-field">
                        <div class="field-label">Submitted On</div>
                        <div class="field-value">${formattedDate}</div>
                    </div>
                </div>
            `;
            
            // Add images if available
            if (submission.images && submission.images.length > 0) {
                const cardBody = card.querySelector('.card-body');
                const imagesDiv = document.createElement('div');
                imagesDiv.className = 'card-images';
                
                submission.images.forEach((imageUrl, index) => {
                    if (imageUrl) {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = `${submission.appName} Screenshot ${index + 1}`;
                        img.className = 'card-image';
                        img.onclick = function() {
                            showImage(imageUrl);
                        };
                        imagesDiv.appendChild(img);
                    }
                });
                
                cardBody.appendChild(imagesDiv);
            }
            
            // Add action buttons
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'card-actions';
            
            // View Full Story button
            const viewButton = document.createElement('button');
            viewButton.className = 'btn btn-view';
            viewButton.textContent = 'View Full Story';
            viewButton.onclick = function() {
                showStory(submission);
            };
            actionsDiv.appendChild(viewButton);
            
            // Direct Update button - NEW!
            const directUpdateButton = document.createElement('button');
            directUpdateButton.className = 'btn btn-view';
            directUpdateButton.textContent = 'Direct Update';
            directUpdateButton.onclick = function() {
                document.getElementById('direct-story-id').value = submission.id;
                document.getElementById('direct-status').value = submission.status || 'pending';
                openDirectUpdate();
            };
            actionsDiv.appendChild(directUpdateButton);
            
            // Add approve/reject buttons based on current status
            if (submission.status === 'pending') {
                // Approve button
                const approveButton = document.createElement('button');
                approveButton.className = 'btn btn-approve';
                approveButton.textContent = 'Approve';
                approveButton.onclick = function() {
                    approveSubmission(submission.id);
                };
                actionsDiv.appendChild(approveButton);
                
                // Reject button
                const rejectButton = document.createElement('button');
                rejectButton.className = 'btn btn-reject';
                rejectButton.textContent = 'Reject';
                rejectButton.onclick = function() {
                    rejectSubmission(submission.id);
                };
                actionsDiv.appendChild(rejectButton);
            } else if (submission.status === 'approved') {
                // Reject button (can change from approved to rejected)
                const rejectButton = document.createElement('button');
                rejectButton.className = 'btn btn-reject';
                rejectButton.textContent = 'Reject';
                rejectButton.onclick = function() {
                    rejectSubmission(submission.id);
                };
                actionsDiv.appendChild(rejectButton);
            } else if (submission.status === 'rejected') {
                // Approve button (can change from rejected to approved)
                const approveButton = document.createElement('button');
                approveButton.className = 'btn btn-approve';
                approveButton.textContent = 'Approve';
                approveButton.onclick = function() {
                    approveSubmission(submission.id);
                };
                actionsDiv.appendChild(approveButton);
            }
            
            card.appendChild(actionsDiv);
            
            return card;
        }
        
        // Update submission status to approved with improved error handling and retry logic
        async function approveSubmission(id) {
            try {
                document.getElementById('loading-indicator').style.display = 'block';
                
                // Get token from input
                ADMIN_TOKEN = document.getElementById('admin-token').value.trim();
                
                console.log("Attempting to approve with token: " + ADMIN_TOKEN);
                
                // Make API call with exactly the format expected by the server
                const response = await fetch("/.netlify/functions/approve-submission", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + ADMIN_TOKEN  // Space after Bearer is important
                  },
                  body: JSON.stringify({ id })
                });
                
                console.log("Response status:", response.status);
                
                if (!response.ok) {
                  const errorText = await response.text();
                  console.error("API error response:", errorText);
                  throw new Error(errorText);
                }
                
                const result = await response.json();
                console.log("API Response:", result);
                
                // Update localStorage for consistency
                try {
                  const submissions = JSON.parse(localStorage.getItem('appfoundry_submissions') || '[]');
                  const submissionIndex = submissions.findIndex(s => s.id === id);
                  
                  if (submissionIndex !== -1) {
                    submissions[submissionIndex].status = 'approved';
                    localStorage.setItem('appfoundry_submissions', JSON.stringify(submissions));
                    localStorage.setItem('appfoundry_approved_seed', JSON.stringify(submissions));
                  }
                } catch (error) {
                  console.warn("Error updating localStorage:", error);
                }
                
                // Reload submissions
                await loadSubmissions();
                
                alert("Submission approved successfully!");
            } catch (error) {
                console.error("Error approving submission:", error);
                alert("Error approving submission: " + error.message);
                
                // Check if it's a conflict error
                if (error.message && error.message.includes("409") || 
                    error.message && error.message.includes("is at") && error.message.includes("but expected")) {
                    
                    // This is a GitHub conflict error (SHA mismatch)
                    const useDirectMethod = confirm("A conflict was detected when trying to approve this submission. Would you like to use the Direct Update method to avoid conflicts?");
                    
                    if (useDirectMethod) {
                        document.getElementById('direct-story-id').value = id;
                        document.getElementById('direct-status').value = 'approved';
                        openDirectUpdate();
                        document.getElementById('loading-indicator').style.display = 'none';
                        return;
                    }
                }
                
                // Update localStorage as fallback
                try {
                    const submissions = JSON.parse(localStorage.getItem('appfoundry_submissions') || '[]');
                    const submissionIndex = submissions.findIndex(s => s.id === id);
                    
                    if (submissionIndex !== -1) {
                        submissions[submissionIndex].status = 'approved';
                        localStorage.setItem('appfoundry_submissions', JSON.stringify(submissions));
                        localStorage.setItem('appfoundry_approved_seed', JSON.stringify(submissions));
                        await loadSubmissions();
                        alert("Submission updated in localStorage only.");
                    }
                } catch (localStorageError) {
                    console.error("Error in localStorage fallback:", localStorageError);
                }
            } finally {
                document.getElementById('loading-indicator').style.display = 'none';
            }
        }
        
        // Update submission status to rejected with improved error handling
        async function rejectSubmission(id) {
            try {
                document.getElementById('loading-indicator').style.display = 'block';
                
                // Get token from input
                ADMIN_TOKEN = document.getElementById('admin-token').value.trim();
                
                console.log("Attempting to reject with token: " + ADMIN_TOKEN);
                
                // Make API call with exactly the format expected by the server
                const response = await fetch("/.netlify/functions/reject-submission", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + ADMIN_TOKEN  // Space after Bearer is important
                  },
                  body: JSON.stringify({ id })
                });
                
                console.log("Response status:", response.status);
                
                if (!response.ok) {
                  const errorText = await response.text();
                  console.error("API error response:", errorText);
                  throw new Error(errorText);
                }
                
                const result = await response.json();
                console.log("API Response:", result);
                
                // Update localStorage for consistency
                try {
                  const submissions = JSON.parse(localStorage.getItem('appfoundry_submissions') || '[]');
                  const submissionIndex = submissions.findIndex(s => s.id === id);
                  
                  if (submissionIndex !== -1) {
                    submissions[submissionIndex].status = 'rejected';
                    localStorage.setItem('appfoundry_submissions', JSON.stringify(submissions));
                    localStorage.setItem('appfoundry_approved_seed', JSON.stringify(submissions));
                  }
                } catch (error) {
                  console.warn("Error updating localStorage:", error);
                }
                
                // Reload submissions
                await loadSubmissions();
                
                alert("Submission rejected successfully!");
            } catch (error) {
                console.error("Error rejecting submission:", error);
                alert("Error rejecting submission: " + error.message);
                
                // Check if it's a conflict error
                if (error.message && error.message.includes("409") || 
                    error.message && error.message.includes("is at") && error.message.includes("but expected")) {
                    
                    // This is a GitHub conflict error (SHA mismatch)
                    const useDirectMethod = confirm("A conflict was detected when trying to reject this submission. Would you like to use the Direct Update method to avoid conflicts?");
                    
                    if (useDirectMethod) {
                        document.getElementById('direct-story-id').value = id;
                        document.getElementById('direct-status').value = 'rejected';
                        openDirectUpdate();
                        document.getElementById('loading-indicator').style.display = 'none';
                        return;
                    }
                }
                
                // Update localStorage as fallback
                try {
                    const submissions = JSON.parse(localStorage.getItem('appfoundry_submissions') || '[]');
                    const submissionIndex = submissions.findIndex(s => s.id === id);
                    
                    if (submissionIndex !== -1) {
                        submissions[submissionIndex].status = 'rejected';
                        localStorage.setItem('appfoundry_submissions', JSON.stringify(submissions));
                        localStorage.setItem('appfoundry_approved_seed', JSON.stringify(submissions));
                        await loadSubmissions();
                        alert("Submission updated in localStorage only.");
                    }
                } catch (localStorageError) {
                    console.error("Error in localStorage fallback:", localStorageError);
                }
            } finally {
                document.getElementById('loading-indicator').style.display = 'none';
            }
        }
        
        // Change tab
        function changeTab(status) {
            // Update current tab
            currentTab = status;
            
            // Update UI
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.dataset.status === status) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Reset to first page
            currentPage = 1;
            
            // Display submissions for the new tab
            loadSubmissions();
        }
        
        // Show full story in modal
        function showStory(submission) {
            // Set current story ID
            currentStoryId = submission.id;
            
            // Set modal title
            document.getElementById('modal-title').textContent = submission.appName;
            
            // Create modal content
            let modalContent = `
                <div class="card-field">
                    <div class="field-label">Story ID</div>
                    <div class="field-value">${submission.id}</div>
                </div>
                <div class="card-field">
                    <div class="field-label">Submitted By</div>
                    <div class="field-value">${submission.name} (${submission.email})</div>
                </div>
                <div class="card-field">
                    <div class="field-label">App Type</div>
                    <div class="field-value">${submission.appType || submission.app_type || 'Not specified'}</div>
                </div>
                <div class="card-field">
                    <div class="field-label">Experience Level</div>
                    <div class="field-value">${submission.experienceLevel || 'Not specified'}</div>
                </div>
                <div class="card-field">
                    <div class="field-label">Testimonial</div>
                    <div class="testimonial">${submission.testimonial}</div>
                </div>
                <div class="card-field">
                    <div class="field-label">Full Story</div>
                    <div class="story-content">${submission.story}</div>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            
            // Add images
            const imagesContainer = document.getElementById('modal-images');
            imagesContainer.innerHTML = '';
            
            if (submission.images && submission.images.length > 0) {
                submission.images.forEach((imageUrl, index) => {
                    if (imageUrl) {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = `${submission.appName} Screenshot ${index + 1}`;
                        img.className = 'modal-image';
                        img.onclick = function() {
                            showImage(imageUrl);
                        };
                        imagesContainer.appendChild(img);
                    }
                });
                imagesContainer.style.display = 'grid';
            } else {
                imagesContainer.style.display = 'none';
            }
            
            // Show modal
            document.getElementById('story-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        // Close the modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
            if (modalId === 'story-modal') {
                currentStoryId = null;
            }
        }
        
        // Show image in viewer
        function showImage(imageUrl) {
            document.getElementById('full-image').src = imageUrl;
            document.getElementById('image-viewer').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        // Close image viewer
        function closeImageViewer() {
            document.getElementById('image-viewer').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Show empty state
        function showEmptyState() {
            document.getElementById('submissions').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
            document.getElementById('pagination').innerHTML = '';
        }
        
        // Update pagination UI
        function updatePagination(totalPages) {
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = '';
            
            // Only show pagination if more than one page
            if (totalPages <= 1) {
                return;
            }
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.className = 'page-button' + (currentPage === 1 ? ' disabled' : '');
            prevButton.textContent = 'Previous';
            prevButton.onclick = function() {
                if (currentPage > 1) {
                    currentPage--;
                    displaySubmissions();
                }
            };
            paginationContainer.appendChild(prevButton);
            
            // Page buttons
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = 'page-button' + (i === currentPage ? ' active' : '');
                pageButton.textContent = i;
                pageButton.onclick = function() {
                    currentPage = i;
                    displaySubmissions();
                };
                paginationContainer.appendChild(pageButton);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.className = 'page-button' + (currentPage === totalPages ? ' disabled' : '');
            nextButton.textContent = 'Next';
            nextButton.onclick = function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    displaySubmissions();
                }
            };
            paginationContainer.appendChild(nextButton);
        }
        
        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal('story-modal');
                closeModal('direct-update-modal');
                closeImageViewer();
            }
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            const storyModal = document.getElementById('story-modal');
            const directUpdateModal = document.getElementById('direct-update-modal');
            const imageViewer = document.getElementById('image-viewer');
            
            if (e.target === storyModal) {
                closeModal('story-modal');
            }
            
            if (e.target === directUpdateModal) {
                closeModal('direct-update-modal');
            }
            
            if (e.target === imageViewer) {
                closeImageViewer();
            }
        });

        // Export Approved Stories to JSON
        function exportApprovedStories() {
            try {
                document.getElementById('loading-indicator').style.display = 'block';
                
                // Get token from input
                ADMIN_TOKEN = document.getElementById('admin-token').value.trim();
                
                // Get approved stories
                fetch('/.netlify/functions/get-submissions?status=approved', {
                    headers: {
                        "Authorization": "Bearer " + ADMIN_TOKEN
                    }
                })
                .then(response => response.json())
                .then(approvedStories => {
                    if (approvedStories.length === 0) {
                        showExportResult('No approved stories found to export.', 'error');
                        return;
                    }
                    
                    // Create formatted JSON
                    const jsonContent = JSON.stringify(approvedStories, null, 2);
                    
                    // Create a Blob with the JSON content
                    const blob = new Blob([jsonContent], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    // Create a download link
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'approved-stories.json';
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    
                    // Clean up
                    URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showExportResult(`Exported ${approvedStories.length} approved stories. Upload this JSON file to your website.`, 'success');
                })
                .catch(error => {
                    console.error('Error exporting from API:', error);
                    
                    // Fall back to localStorage
                    try {
                        const storedSubmissions = localStorage.getItem('appfoundry_submissions');
                        
                        if (storedSubmissions) {
                            const allSubmissions = JSON.parse(storedSubmissions);
                            const approvedStories = allSubmissions.filter(story => story.status === 'approved');
                            
                            if (approvedStories.length === 0) {
                                showExportResult('No approved stories found to export.', 'error');
                                return;
                            }
                            
                            // Create formatted JSON
                            const jsonContent = JSON.stringify(approvedStories, null, 2);
                            
                            // Create a Blob with the JSON content
                            const blob = new Blob([jsonContent], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            
                            // Create a download link
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'approved-stories.json';
                            a.style.display = 'none';
                            document.body.appendChild(a);
                            a.click();
                            
                            // Clean up
                            URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                            
                            showExportResult(`Exported ${approvedStories.length} approved stories from localStorage. Upload this JSON file to your website.`, 'success');
                        } else {
                            showExportResult('No submissions found to export.', 'error');
                        }
                    } catch (localStorageError) {
                        console.error('Error exporting from localStorage:', localStorageError);
                        showExportResult(`Error: ${localStorageError.message}`, 'error');
                    }
                })
                .finally(() => {
                    document.getElementById('loading-indicator').style.display = 'none';
                });
            } catch (error) {
                console.error('Error exporting approved stories:', error);
                showExportResult(`Error: ${error.message}`, 'error');
                document.getElementById('loading-indicator').style.display = 'none';
            }
        }

        // Helper function to show export result
        function showExportResult(message, type) {
            const resultDiv = document.getElementById('export-result');
            resultDiv.textContent = message;
            resultDiv.style.display = 'inline-block';
            
            if (type === 'success') {
                resultDiv.className = 'export-success';
            } else {
                resultDiv.className = 'export-error';
            }
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 10000);
        }
        
        // Hook approval buttons (for Story Manager)
        function hookApprovalButtons() {
            // This will be called by the Story Manager script
            document.addEventListener('DOMContentLoaded', function() {
                console.log("üîç Looking for approval/rejection buttons to hook");
                
                // We'll use a mutation observer to watch for changes to the DOM
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList') {
                            const addedNodes = Array.from(mutation.addedNodes);
                            addedNodes.forEach(function(node) {
                                if (node.nodeType === 1) { // Element node
                                    // Look for approve/reject buttons in this node
                                    const buttons = node.querySelectorAll('button[onclick*="approve"], button[onclick*="reject"]');
                                    buttons.forEach(hookButton);
                                    
                                    // Also look for buttons directly added
                                    if (node.tagName === 'BUTTON') {
                                        if (node.getAttribute('onclick')?.includes('approve') || 
                                            node.getAttribute('onclick')?.includes('reject')) {
                                            hookButton(node);
                                        }
                                    }
                                }
                            });
                        }
                    });
                });
                
                // Start observing the entire document
                observer.observe(document.body, { 
                    childList: true, 
                    subtree: true 
                });
                
                // Also hook any buttons that are already on the page
                const existingButtons = document.querySelectorAll('button[onclick*="approve"], button[onclick*="reject"]');
                existingButtons.forEach(hookButton);
                
                console.log("üëÅÔ∏è Now watching for approval/rejection actions");
            });
        }
        
        // Hook a button to update the seed when clicked
        function hookButton(button) {
            // Don't hook buttons that are already hooked
            if (button.dataset.hooked) return;
            
            // Mark this button as hooked so we don't hook it again
            button.dataset.hooked = "true";
            console.log("üîó Hooking button:", button.textContent);
            
            // Get the original onclick handler
            const originalOnclick = button.getAttribute('onclick');
            
            // Replace it with our own handler
            button.setAttribute('onclick', '');
            button.addEventListener('click', function(e) {
                // Call the original handler
                if (originalOnclick) {
                    eval(originalOnclick);
                }
                
                // Then update the seed
                console.log("üîÑ Button clicked, updating seed after delay");
                
                // We need to wait a bit for the original handler to finish
                setTimeout(function() {
                    try {
                        const submissions = JSON.parse(localStorage.getItem('appfoundry_submissions') || '[]');
                        localStorage.setItem('appfoundry_approved_seed', JSON.stringify(submissions));
                        console.log("üíæ Seed updated after approval/rejection with", submissions.length, "stories");
                        
                        // Count the approved stories
                        const approvedCount = submissions.filter(s => s.status === 'approved').length;
                        console.log("‚úì There are now", approvedCount, "approved stories");
                    } catch (e) {
                        console.error("‚ùå Error updating seed after approval/rejection:", e);
                    }
                }, 200);
            });
        }
    </script>
</body>
</html>
